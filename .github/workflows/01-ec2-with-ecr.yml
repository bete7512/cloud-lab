name: 01-ec2-with-ecr

on:
  push:
    branches:
      - main
    paths:
      - "01-ec2-with-ecr/**"
      - ".github/workflows/01-ec2-with-ecr.yml"

permissions:
  id-token: write 
  contents: read

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: 01-ec2-with-ecr/infra
        run: |
          TF_BACKEND_BUCKET="${{ secrets.TF_BACKEND_BUCKET }}"
          TF_BACKEND_KEY="${{ secrets.TF_BACKEND_KEY }}"
          TF_BACKEND_DYNAMODB_TABLE="${{ secrets.TF_BACKEND_DYNAMODB_TABLE }}"
          TF_BACKEND_REGION="${{ secrets.TF_BACKEND_REGION }}"
          
          # Set defaults if secrets are empty
          TF_BACKEND_BUCKET=${TF_BACKEND_BUCKET:-cloud-lab-terraform-state}
          TF_BACKEND_KEY=${TF_BACKEND_KEY:-01-ec2-with-ecr/terraform.tfstate}
          TF_BACKEND_DYNAMODB_TABLE=${TF_BACKEND_DYNAMODB_TABLE:-cloud-lab-terraform-state-lock}
          TF_BACKEND_REGION=${TF_BACKEND_REGION:-${{ secrets.AWS_REGION }}}
          
          terraform init \
            -backend-config="bucket=$TF_BACKEND_BUCKET" \
            -backend-config="key=$TF_BACKEND_KEY" \
            -backend-config="dynamodb_table=$TF_BACKEND_DYNAMODB_TABLE" \
            -backend-config="region=$TF_BACKEND_REGION" \
            -backend-config="encrypt=true"

      - name: Terraform Apply
        working-directory: 01-ec2-with-ecr/infra
        run: terraform apply -auto-approve

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: terraform
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPO: ${{ secrets.ECR_REPO }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        working-directory: 01-ec2-with-ecr/app
        run: |
          docker build -t $ECR_REPO:latest .

      - name: Tag Docker image
        run: |
          docker tag $ECR_REPO:latest \
          $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest

      - name: Push Docker image to ECR
        run: |
          docker push \
          $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest
  deploy-docker-image:
    name: Deploy Docker Image
    runs-on: ubuntu-latest
    needs: build-and-push
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPO: ${{ secrets.ECR_REPO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        working-directory: 01-ec2-with-ecr/infra
        run: |
          TF_BACKEND_BUCKET="${{ secrets.TF_BACKEND_BUCKET }}"
          TF_BACKEND_KEY="${{ secrets.TF_BACKEND_KEY }}"
          TF_BACKEND_DYNAMODB_TABLE="${{ secrets.TF_BACKEND_DYNAMODB_TABLE }}"
          TF_BACKEND_REGION="${{ secrets.TF_BACKEND_REGION }}"
          
          # Set defaults if secrets are empty
          TF_BACKEND_BUCKET=${TF_BACKEND_BUCKET:-cloud-lab-terraform-state}
          TF_BACKEND_KEY=${TF_BACKEND_KEY:-01-ec2-with-ecr/terraform.tfstate}
          TF_BACKEND_DYNAMODB_TABLE=${TF_BACKEND_DYNAMODB_TABLE:-cloud-lab-terraform-state-lock}
          TF_BACKEND_REGION=${TF_BACKEND_REGION:-${{ secrets.AWS_REGION }}}
          
          terraform init \
            -backend-config="bucket=$TF_BACKEND_BUCKET" \
            -backend-config="key=$TF_BACKEND_KEY" \
            -backend-config="dynamodb_table=$TF_BACKEND_DYNAMODB_TABLE" \
            -backend-config="region=$TF_BACKEND_REGION" \
            -backend-config="encrypt=true"
      
      - name: Get EC2 Instance ID
        id: ec2_instance
        working-directory: 01-ec2-with-ecr/infra
        run: |
          INSTANCE_ID=$(terraform output -raw ec2_instance_id)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "EC2 Instance ID: $INSTANCE_ID"
      
      - name: Get EC2 Public IP
        id: ec2_ip
        working-directory: 01-ec2-with-ecr/infra
        run: |
          PUBLIC_IP=$(terraform output -raw ec2_public_ip)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $PUBLIC_IP"
      
      - name: Wait for EC2 instance to be ready
        run: |
          echo "Waiting for EC2 instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids ${{ steps.ec2_instance.outputs.instance_id }} --region ${{ secrets.AWS_REGION }}
          echo "EC2 instance is ready"
      
      - name: Deploy Docker image to EC2 instance
        run: |
          ECR_IMAGE="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ steps.ec2_instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters '{"commands":["docker stop app || true","docker rm app || true","aws ecr get-login-password --region '"$AWS_REGION"' | docker login --username AWS --password-stdin '"$ECR_IMAGE"'","docker pull '"$ECR_IMAGE"'","docker run -d --name app -p 8080:8080 --restart unless-stopped '"$ECR_IMAGE"'"]}' \
            --region ${{ secrets.AWS_REGION }} \
            --output text --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for command to complete
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ steps.ec2_instance.outputs.instance_id }} \
            --region ${{ secrets.AWS_REGION }}
          
          # Get command output
          echo "Command output:"
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ steps.ec2_instance.outputs.instance_id }} \
            --region ${{ secrets.AWS_REGION }} \
            --query '[Status,StandardOutputContent,StandardErrorContent]' \
            --output table
      
      - name: Wait for application to start
        run: |
          echo "Waiting for application to start..."
          sleep 15
      
      - name: Test the application
        run: |
          PUBLIC_IP="${{ steps.ec2_ip.outputs.public_ip }}"
          echo "Testing application at http://$PUBLIC_IP"
          curl -f http://$PUBLIC_IP || exit 1
      
      - name: Test the health endpoint
        run: |
          PUBLIC_IP="${{ steps.ec2_ip.outputs.public_ip }}"
          echo "Testing health endpoint at http://$PUBLIC_IP/health"
          curl -f http://$PUBLIC_IP/health || exit 1

